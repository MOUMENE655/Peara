<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peara | تواصل معي</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: #333;
      color: white;
      padding: 1rem;
    }
    button {
      background: #0078ff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: #005fcc; }
    form {
      display: none;
      background: white;
      margin: 2rem auto;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 400px;
    }
    input, textarea {
      width: 95%;
      margin: 8px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    textarea { height: 120px; resize: none; }
    #msg {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Peara</h1>
    <p>تواصل معي بعد تسجيل الدخول</p>
  </header>

  <button id="login">تسجيل الدخول</button>
  <button id="logout" style="display:none;">تسجيل الخروج</button>

  <form id="contact-form" action="https://formspree.io/f/xvgwbdan" method="POST">
    <input type="text" name="name" placeholder="اسمك" required />
    <input type="email" name="email" placeholder="بريدك الإلكتروني" required />
    <textarea name="message" placeholder="اكتب رسالتك هنا..." required></textarea>
    <button type="submit">إرسال</button>
    <p id="msg"></p>
  </form>

  <script type="module">
    import createAuth0Client from "https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2.1.0/dist/auth0-spa-js.production.esm.min.js";

    const auth0 = await createAuth0Client({
      domain: "dev-cpi8o3elw1o1xe1m.us.auth0.com",
      clientId: "7KovmuJ1lp4OlcLB8KnRgSto9G4Usgd9",
      authorizationParams: {
        redirect_uri: window.location.origin + window.location.pathname
      }
    });

    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const contactForm = document.getElementById("contact-form");

    async function handleAuth() {
      const query = window.location.search;
      if (query.includes("code=") && query.includes("state=")) {
        await auth0.handleRedirectCallback();
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      const isAuthenticated = await auth0.isAuthenticated();

      if (isAuthenticated) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        contactForm.style.display = "block";
      } else {
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        contactForm.style.display = "none";
      }
    }

    loginBtn.onclick = () => auth0.loginWithRedirect();
    logoutBtn.onclick = () => auth0.logout({ logoutParams: { returnTo: window.location.origin + "/Peara/" } });

    handleAuth();
  </script>

  <script>
    const form = document.getElementById("contact-form");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const response = await fetch(form.action, {
        method: "POST",
        body: data,
        headers: { Accept: "application/json" }
      });
      document.getElementById("msg").innerText =
        response.ok ? "✅ تم الإرسال بنجاح" : "⚠️ حدث خطأ أثناء الإرسال";
      form.reset();
    });
  </script>
</body>
</html>
